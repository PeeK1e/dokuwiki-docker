stages:          # List of stages for jobs, and their order of execution
  - build
  - deploy

#disabling docker-tls, bug?
variables:
  DOCKER_TLS_CERTDIR: ""
  IMAGE_NAME: peek1e/dokuwiki-docker

services:
  - docker:dind

before_script:
  - docker pull "$IMAGE_NAME:latest"

build-job:
  stage: build
  script:
   - docker build --cache-from "$IMAGE_NAME:latest" -t "$IMAGE_NAME:latest" ./setup

deploy-job:
  stage: deploy
  before_script: 
    - echo $CITOKEN | docker login -u $CIUSER --password-stdin
  script:
    - docker build --cache-from "$IMAGE_NAME:latest" -t "$IMAGE_NAME:latest" ./setup
    - docker push $IMAGE_NAME
  only:
    - release